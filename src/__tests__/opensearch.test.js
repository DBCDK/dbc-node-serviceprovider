'use strict';

import {expect, assert} from 'chai';
import * as Provider from '../Provider.js';
Provider.init({opensearch: {}});
const transform = require('../transformers/OpenSearch/ResultList.transform.js');
const worktransform = require('../transformers/OpenSearch/Work.transform.js');

/*describe('Test transform of OpenSearch requests', () => {
  it('Sort default', function() {
		
		let request = {"query":"harry potter","offset":"1","worksPerPage":"10","sort":"default"};
	
		assert.equal(JSON.stringify(transform.requestTransform('getSearchResultList', request)), JSON.stringify({"query":"harry potter","start":"1","stepValue":"10","sort":"rank_frequency"}), "Search query with default sort");
		
	});
	it('Sort rank on title', function() {
		
		let request = {"query":"harry potter","offset":"1","worksPerPage":"10","sort":"rank_title"};
	
		assert.equal(JSON.stringify(transform.requestTransform('getSearchResultList', request)), JSON.stringify({"query":"harry potter","start":"1","stepValue":"10","sort":"rank_title"}), "Search query with default sort");
		
	});
});*/

describe('Test transform of OpenSearch responses', () => {
	it('Check one hit', function() {
		
		let response = {"result":{"hitCount":"1","collectionCount":"1","more":"false","sortUsed":"rank_subject","searchResult":{"collection":{"resultPosition":"1","numberOfObjects":"1","object":{"identifier":"870970-basis:27036031","recordStatus":"active","creationDate":"2007-11-26","formatsAvailable":{"format":["dkabm","marcxchange"]}}},"formattedCollection":{"briefDisplay":{"manifestation":{"accessType":"physical","fedoraPid":"870970-basis:27036031","identifier":"870970-basis:27036031","title":"Harry Potter og Fønixordenen","titleFull":"Harry Potter og Fønixordenen","type":"Playstation 2","workType":"game"}}}},"facetResult":{},"statInfo":{"fedoraRecordsCached":"4","fedoraRecordsRead":"1","time":"0.205224","trackingId":"os:2015-06-15T11:47:46:535154:6359"}}};

		assert.equal(JSON.stringify(transform.responseTransform(response)), JSON.stringify({"result":[{"identifiers":["870970-basis:27036031"],"title":"Harry Potter og Fønixordenen","workType":"game"}],"info":{"hits":"1","collections":"1","more":"false"},"error":[]}), "One hit in search result");
		
	});
	it('Check more hits', function() {
		
		let response = {"result":{"hitCount":"2","collectionCount":"2","more":"false","sortUsed":"rank_subject","searchResult":[{"collection":{"resultPosition":"1","numberOfObjects":"1","object":{"identifier":"870970-basis:27036031","recordStatus":"active","creationDate":"2007-11-26","formatsAvailable":{"format":["dkabm","marcxchange"]}}},"formattedCollection":{"briefDisplay":{"manifestation":{"accessType":"physical","fedoraPid":"870970-basis:27036031","identifier":"870970-basis:27036031","title":"Harry Potter og Fønixordenen","titleFull":"Harry Potter og Fønixordenen","type":"Playstation 2","workType":"game"}}}},{"collection":{"resultPosition":"2","numberOfObjects":"1","object":{"identifier":"870970-basis:29317038","recordStatus":"active","creationDate":"2012-04-03","formatsAvailable":{"format":["dkabm","marcxchange"]}}},"formattedCollection":{"briefDisplay":{"manifestation":{"accessType":"physical","creator":"Joanne K. Rowling","fedoraPid":"870970-basis:29317038","identifier":"870970-basis:29317038","language":"Dansk","title":"Harry Potter og De Vises Sten","titleFull":"Harry Potter og De Vises Sten","type":"Bog","workType":"book"}}}}],"facetResult":{},"statInfo":{"fedoraRecordsCached":"3","fedoraRecordsRead":"7","time":"1.831044","trackingId":"os:2015-06-15T12:48:15:288498:31926"}}};
		
		assert.equal(JSON.stringify(transform.responseTransform(response)), JSON.stringify({"result":[{"identifiers":["870970-basis:27036031"],"title":"Harry Potter og Fønixordenen","workType":"game"},{"identifiers":["870970-basis:29317038"],"title":"Harry Potter og De Vises Sten","workType":"book"}],"info":{"hits":"2","collections":"2","more":"false"},"error":[]}), "More hits in search result");
		
	});
	it('Check more hits one work', function() {
		
		let response = {"result":{"hitCount":"2","collectionCount":"1","more":"false","sortUsed":"rank_subject","searchResult":{"collection":{"resultPosition":"1","numberOfObjects":"2","object":[{"identifier":"870970-basis:22252852","recordStatus":"active","creationDate":"2005-03-01","formatsAvailable":{"format":["dkabm","marcxchange"]}},{"identifier":"870970-basis:29317038","recordStatus":"active","creationDate":"2012-04-03","formatsAvailable":{"format":["dkabm","marcxchange"]}}]},"formattedCollection":{"briefDisplay":{"manifestation":[{"accessType":"physical","creator":"Joanne K. Rowling","fedoraPid":"870970-basis:22252852","identifier":"870970-basis:22252852","language":"Dansk","title":"Harry Potter og De Vises Sten","titleFull":"Harry Potter og De Vises Sten","type":"Bog","workType":"book"},{"accessType":"physical","creator":"Joanne K. Rowling","fedoraPid":"870970-basis:29317038","identifier":"870970-basis:29317038","language":"Dansk","title":"Harry Potter og De Vises Sten","titleFull":"Harry Potter og De Vises Sten","type":"Bog","workType":"book"}]}}},"facetResult":{},"statInfo":{"fedoraRecordsCached":"8","fedoraRecordsRead":"0","time":"0.307299","trackingId":"os:2015-06-15T12:50:59:869318:31926"}}};
		
		assert.equal(JSON.stringify(transform.responseTransform(response)), JSON.stringify({"result":[{"identifiers":["870970-basis:22252852","870970-basis:29317038"],"title":"Harry Potter og De Vises Sten","workType":"book"}],"info":{"hits":"2","collections":"1","more":"false"},"error":[]}), "More hits in one work collection");
		
	});
	it('Check no hits', function() {
		
		let response = {"result":{"hitCount":"0","collectionCount":"0","more":"false","sortUsed":"rank_main_title","facetResult":{},"statInfo":{"fedoraRecordsCached":"0","fedoraRecordsRead":"0","time":"0.181227","trackingId":"os:2015-06-15T12:53:41:207552:6791"}}};
		assert.equal(JSON.stringify(transform.responseTransform(response)), JSON.stringify({"result":[],"info":{"hits":"0","collections":"0","more":"false"},"error":[]}), "No records found");
		
	});
	it('Check authentication error', function() {
		
		let response = {"error":"authentication_error"};
		
		assert.equal(JSON.stringify(transform.responseTransform(response)), JSON.stringify({"result":[],"info":{},"error":[{"errorcode":1,"errormessage":"Authentication error","serviceerror":"authentication_error"}]}), "Authentication error");
		
	});

});

describe('Test transform of OpenSearch Work responses', () => {
  it('Five manifestations in a work', function() {
		
		let response = {"result":{"hitCount":"1","collectionCount":"1","more":"false","sortUsed":"date_descending","searchResult":{"collection":{"resultPosition":"1","numberOfObjects":"5","object":[{"record":{"identifier":["25245784|870970",{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"87-02-02944-8"},{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"9788702029444"}],"source":["Bibliotekskatalog","Harry Potter and the Order of the Phoenix"],"title":["Harry Potter og Fønixordenen",{"attributes":{"xsi:type":"dkdcplus:full"},"$value":"Harry Potter og Fønixordenen"}],"alternative":"Harry Potter og Fønixordenen","creator":[{"attributes":{"xsi:type":"dkdcplus:aut"},"$value":"Joanne K. Rowling"},{"attributes":{"xsi:type":"oss:sort"},"$value":"Rowling, Joanne K."}],"subject":[{"attributes":{"xsi:type":"dkdcplus:DK5-Text"},"$value":"Skønlitteratur"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:genre"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 12 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 13 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 14 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 15 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 16 år"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"magi"},{"attributes":{"xsi:type":"dkdcplus:DK5"},"$value":"sk"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"troldmænd"}],"abstract":"Fantasy. Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","description":{"attributes":{"xsi:type":"dkdcplus:series"},"$value":"5. del af: Harry Potter og De Vises Sten"},"audience":"børnematerialer","version":"2. udgave","publisher":"Gyldendal","date":"2004","type":{"attributes":{"xsi:type":"dkdcplus:BibDK-Type"},"$value":"Bog"},"extent":"923 sider","language":[{"attributes":{"xsi:type":"dcterms:ISO639-2"},"$value":"dan"},"Dansk"]},"identifier":"870970-basis:25245784","recordStatus":"active","creationDate":"2005-03-02","formatsAvailable":{"format":["dkabm","marcxchange"]}},{"record":{"identifier":["29368872|870970",{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"9788702114393"}],"source":["Bibliotekskatalog","Harry Potter and the Order of the Phoenix"],"title":["Harry Potter og Fønixordenen",{"attributes":{"xsi:type":"dkdcplus:full"},"$value":"Harry Potter og Fønixordenen"}],"alternative":"Harry Potter og Fønixordenen","creator":[{"attributes":{"xsi:type":"dkdcplus:aut"},"$value":"Joanne K. Rowling"},{"attributes":{"xsi:type":"oss:sort"},"$value":"Rowling, Joanne K."}],"subject":[{"attributes":{"xsi:type":"dkdcplus:DK5-Text"},"$value":"Skønlitteratur"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:genre"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 12 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 13 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 14 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 15 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 16 år"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"magi"},{"attributes":{"xsi:type":"dkdcplus:DK5"},"$value":"sk"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"troldmænd"}],"abstract":"Fantasy. Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","description":{"attributes":{"xsi:type":"dkdcplus:series"},"$value":"5. del af: Harry Potter og De Vises Sten"},"audience":"børnematerialer","version":"4. udgave","publisher":"Gyldendal","contributor":{"attributes":{"xsi:type":"dkdcplus:trl"},"$value":"Hanna Lützen"},"date":"2012","type":{"attributes":{"xsi:type":"dkdcplus:BibDK-Type"},"$value":"Bog"},"extent":"923 sider","language":[{"attributes":{"xsi:type":"dcterms:ISO639-2"},"$value":"dan"},"Dansk"]},"identifier":"870970-basis:29368872","recordStatus":"active","creationDate":"2012-05-08","formatsAvailable":{"format":["dkabm","marcxchange"]}},{"record":{"identifier":["24880605|870970",{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"87-02-02222-2"}],"source":["Bibliotekskatalog","Harry Potter and the Order of the Phoenix"],"title":["Harry Potter og Fønixordenen",{"attributes":{"xsi:type":"dkdcplus:full"},"$value":"Harry Potter og Fønixordenen"}],"creator":[{"attributes":{"xsi:type":"dkdcplus:aut"},"$value":"Joanne K. Rowling"},{"attributes":{"xsi:type":"oss:sort"},"$value":"Rowling, Joanne K."}],"subject":[{"attributes":{"xsi:type":"dkdcplus:DK5-Text"},"$value":"Skønlitteratur"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:genre"},"$value":"fantasy"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 12 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 13 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 14 år"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"magi"},{"attributes":{"xsi:type":"dkdcplus:DK5"},"$value":"sk"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"troldmænd"}],"abstract":"Fantasy. Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","description":{"attributes":{"xsi:type":"dkdcplus:series"},"$value":"5. del af: Harry Potter og De Vises Sten"},"audience":"børnematerialer","version":"3. oplag","publisher":"Gyldendal","date":"2003","type":{"attributes":{"xsi:type":"dkdcplus:BibDK-Type"},"$value":"Bog"},"extent":"923 sider","language":[{"attributes":{"xsi:type":"dcterms:ISO639-2"},"$value":"dan"},"Dansk"]},"identifier":"870970-basis:24880605","recordStatus":"active","creationDate":"2005-03-02","formatsAvailable":{"format":["dkabm","marcxchange"]}},{"record":{"identifier":["26167663|870970",{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"87-02-04746-2"}],"source":["Bibliotekskatalog","Harry Potter and the Order of the Phoenix"],"title":["Harry Potter og Fønixordenen",{"attributes":{"xsi:type":"dkdcplus:full"},"$value":"Harry Potter og Fønixordenen"}],"creator":[{"attributes":{"xsi:type":"dkdcplus:aut"},"$value":"Joanne K. Rowling"},{"attributes":{"xsi:type":"oss:sort"},"$value":"Rowling, Joanne K."}],"subject":[{"attributes":{"xsi:type":"dkdcplus:DK5-Text"},"$value":"Skønlitteratur"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"eventyrlige fortællinger"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 12 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 13 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 14 år"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"magi"},{"attributes":{"xsi:type":"dkdcplus:DK5"},"$value":"sk"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"troldmænd"}],"abstract":"Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","description":["Cd 7 fejlagtigt med titel: Harry Potter og flammernes pokal",{"attributes":{"xsi:type":"dkdcplus:series"},"$value":"5. del af: Harry Potter og De Vises Sten"}],"audience":"børnematerialer","publisher":"Gyldendal Lyd","contributor":["Jesper Christensen (f. 1948)",{"attributes":{"xsi:type":"dkdcplus:dkind"},"$value":"Jesper Christensen"}],"date":"2006","type":{"attributes":{"xsi:type":"dkdcplus:BibDK-Type"},"$value":"Lydbog (cd)"},"format":"25 cd'er","extent":"29 t., 33 min.","language":[{"attributes":{"xsi:type":"dcterms:ISO639-2"},"$value":"dan"},"Dansk"]},"identifier":"870970-basis:26167663","recordStatus":"active","creationDate":"2006-12-04","formatsAvailable":{"format":["dkabm","marcxchange"]}},{"record":{"identifier":["27639534|870970",{"attributes":{"xsi:type":"dkdcplus:ISBN"},"$value":"9788702075427"}],"source":["Bibliotekskatalog","Harry Potter and the Order of the Phoenix"],"title":["Harry Potter og Fønixordenen",{"attributes":{"xsi:type":"dkdcplus:full"},"$value":"Harry Potter og Fønixordenen (mp3)"}],"creator":[{"attributes":{"xsi:type":"dkdcplus:aut"},"$value":"Joanne K. Rowling"},{"attributes":{"xsi:type":"oss:sort"},"$value":"Rowling, Joanne K."}],"subject":[{"attributes":{"xsi:type":"dkdcplus:DK5-Text"},"$value":"Skønlitteratur"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"eventyrlige fortællinger"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 12 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 13 år"},{"attributes":{"xsi:type":"dkdcplus:DBCN"},"$value":"for 14 år"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"magi"},{"attributes":{"xsi:type":"dkdcplus:DK5"},"$value":"sk"},{"attributes":{"xsi:type":"dkdcplus:DBCS"},"$value":"troldmænd"}],"abstract":"Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","description":{"attributes":{"xsi:type":"dkdcplus:series"},"$value":"5. del af: Harry Potter og De Vises Sten"},"audience":"børnematerialer","publisher":"Gyldendal Lyd","contributor":["Jesper Christensen (f. 1948)",{"attributes":{"xsi:type":"dkdcplus:dkind"},"$value":"Jesper Christensen"}],"date":"2009","type":{"attributes":{"xsi:type":"dkdcplus:BibDK-Type"},"$value":"Lydbog (cd-mp3)"},"format":"2 cd'er i 1 mappe, mp3","extent":"29 t., 34 min.","language":[{"attributes":{"xsi:type":"dcterms:ISO639-2"},"$value":"dan"},"Dansk"]},"identifier":"870970-basis:27639534","recordStatus":"active","creationDate":"2009-02-24","formatsAvailable":{"format":["dkabm","marcxchange"]}}]}},"facetResult":{},"statInfo":{"fedoraRecordsCached":"17","fedoraRecordsRead":"0","time":"0.94377","trackingId":"os:2015-06-25T11:00:47:047378:23392"}}};

		assert.equal(JSON.stringify(worktransform.responseTransform(response)), JSON.stringify({"result":{"general":{"title":"Harry Potter og Fønixordenen","creators":["Joanne K. Rowling"],"description":"Fantasy. Da Harry Potter vender tilbage til Hogwarts er meget ændret. Man tror, at han lyver angående Voldemort, og ministeriet sender en repræsentant til skolen, der snart er delt i to fjendtlige lejre","series":"5. del af: Harry Potter og De Vises Sten","subjects":["fantasy","magi","troldmænd"],"languages":["Dansk"]},"specific":[{"type":"Bog","identifiers":["870970-basis:25245784","870970-basis:29368872","870970-basis:24880605"],"dates":["2004","2012","2003"]},{"type":"Lydbog (cd)","identifiers":["870970-basis:26167663"],"dates":["2006"]},{"type":"Lydbog (cd-mp3)","identifiers":["870970-basis:27639534"],"dates":["2009"]}]},"info":{"hits":"1","collections":"1"},"error":[]}), "5 manifestations in work");
		
	});
});